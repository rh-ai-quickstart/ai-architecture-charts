# Build Go proxy
FROM golang:1.21 AS builder
WORKDIR /build

# Copy shared mcpproxy library and oracle-sqlcl proxy
# Structure must match go.mod replace directive: ../../mcpproxy
COPY mcpproxy/ ./mcpproxy/
COPY oracle-sqlcl/proxy/ ./oracle-sqlcl/proxy/

# Build the proxy binary
WORKDIR /build/oracle-sqlcl/proxy
RUN go build -o mcp-proxy .

# SQLcl MCP Server Docker Image
FROM container-registry.oracle.com/database/sqlcl:latest

# Set environment variables for Oracle SQLcl
# Auto-detect JAVA_HOME based on architecture (x64 vs aarch64)
ENV ORACLE_HOME=/opt/oracle/sqlcl
ENV PATH=/opt/oracle/sqlcl/bin:$PATH

# Copy Go proxy binary from builder
COPY --from=builder /build/oracle-sqlcl/proxy/mcp-proxy /usr/local/bin/mcp-proxy

# Copy maintained script and set entrypoint
COPY oracle-sqlcl/scripts/start-mcp.sh /start-mcp.sh
RUN chmod +x /start-mcp.sh

# Start MCP proxy
ENTRYPOINT ["/start-mcp.sh"]
