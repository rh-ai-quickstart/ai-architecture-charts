# Build Go proxy
FROM golang:1.21 AS builder
WORKDIR /build

# Copy proxy source - mcpproxy library is fetched via go mod download
COPY oracle-sqlcl/proxy/ ./

# For local development with replace directive, uncomment the following:
# COPY mcpproxy/ ./mcpproxy/

# Build the proxy binary
RUN go mod download && go build -o mcp-proxy .

# SQLcl MCP Server Docker Image
FROM container-registry.oracle.com/database/sqlcl:latest

# Set environment variables for Oracle SQLcl
# Auto-detect JAVA_HOME based on architecture (x64 vs aarch64)
ENV ORACLE_HOME=/opt/oracle/sqlcl
ENV PATH=/opt/oracle/sqlcl/bin:$PATH

# Copy Go proxy binary from builder
COPY --from=builder /build/mcp-proxy /usr/local/bin/mcp-proxy

# Copy startup script
COPY oracle-sqlcl/scripts/start-mcp.sh /start-mcp.sh
RUN chmod +x /start-mcp.sh

# Start MCP proxy
ENTRYPOINT ["/start-mcp.sh"]
