{{/*
Oracle User Secrets - Auto-generated credentials for application users
Creates one secret per user with connection details
Secret name: oracle-db-user-<username>
*/}}
{{- range .Values.oracle.users }}
{{- $secretName := printf "%s-user-%s" (include "oracle-db.fullname" $) (.name | replace "_" "-") }}
{{- $secret := lookup "v1" "Secret" $.Release.Namespace $secretName }}
{{- $password := "" }}
{{- if and $secret $secret.data }}
{{- $password = index $secret.data "password" | b64dec }}
{{- else }}
{{- $password = randAlphaNum 16 }}
{{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "oracle-db.labels" $ | nindent 4 }}
    app.kubernetes.io/component: user-secret
    oracle-db/user: {{ .name | quote }}
type: Opaque
stringData:
  # User credentials
  username: {{ .name | quote }}
  password: {{ $password | quote }}

  # Schema information
  schema: {{ .schema | quote }}
  mode: {{ .mode | quote }}

  # Connection details (same as main Oracle service)
  host: {{ $.Values.oracle.connection.host | quote }}
  port: {{ $.Values.oracle.connection.port | quote }}
  serviceName: {{ $.Values.oracle.connection.serviceName | quote }}

  # Connection strings
  jdbc-uri: "jdbc:oracle:thin:@//{{ $.Values.oracle.connection.host }}:{{ $.Values.oracle.connection.port }}/{{ $.Values.oracle.connection.serviceName }}"
  connection-string: "{{ .name }}/{{ $password }}@{{ $.Values.oracle.connection.host }}:{{ $.Values.oracle.connection.port }}/{{ $.Values.oracle.connection.serviceName }}"
{{- end }}
