name: Build Packages and Publish Helm Charts

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  detect-changes:
    if: github.repository == 'rh-ai-quickstart/ai-architecture-charts'
    runs-on: ubuntu-latest
    outputs:
      build-matrix: ${{ steps.changes.outputs.build-matrix }}
      changed-helm-components: ${{ steps.changes.outputs.changed-helm-components }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          # Define the original build matrix
          ORIGINAL_MATRIX='{
            "include": [
              {
                "name": "ingestion-pipeline",
                "file": "ingestion-pipeline/Containerfile",
                "chart": "ingestion-pipeline/helm/Chart.yaml",
                "context": "ingestion-pipeline/src"
              },
              {
                "name": "mcp-weather",
                "file": "mcp-servers/weather/Containerfile",
                "context": "mcp-servers/weather/src",
                "chart": "mcp-servers/helm/Chart.yaml"
              },
              {
                "name": "oracle-sqlcl",
                "file": "mcp-servers/oracle-sqlcl/Containerfile",
                "context": "mcp-servers/oracle-sqlcl",
                "chart": "mcp-servers/helm/Chart.yaml"
              },
              {
                "name": "oracle23ai-tpcds",
                "file": "oracle23ai/tpcds-util/Containerfile",
                "context": "oracle23ai/tpcds-util",
                "chart": "oracle23ai/helm/Chart.yaml"
              }
            ]
          }'

          # Get changed files as JSON array (compare against main before this PR was merged)
          CHANGED_FILES_JSON=$(git diff --name-only ${{ github.event.before }}..HEAD | jq -R -s 'split("\n") | map(select(length > 0))')

          # Get all helm components dynamically
          ALL_HELM_COMPONENTS=$(find . -maxdepth 3 -name "Chart.yaml" -path "*/helm/Chart.yaml" | cut -d'/' -f2 | sort | jq -R -s 'split("\n") | map(select(length > 0))')

          echo "Changed files:"
          echo "=============="
          echo "$CHANGED_FILES_JSON" | jq .

          echo "Original build matrix:"
          echo "======================"
          echo "$ORIGINAL_MATRIX" | jq .

          echo "Helm components:"
          echo "================"
          echo "$ALL_HELM_COMPONENTS" | jq .

          # Check if workflow changed and filter build matrix in one jq command
          RESULT=$(echo "$ORIGINAL_MATRIX" | jq --argjson changed_files "$CHANGED_FILES_JSON" --argjson all_helm_components "$ALL_HELM_COMPONENTS" '
            {
              "build_matrix": (
                if ($changed_files | any(test("^\\.github/workflows/"))) then
                  .
                else
                  {
                    "include": [
                      .include[] as $item |
                      $item |
                      select(
                        $changed_files | any(
                          test("^" + ($item.chart | split("/")[0]) + "/")
                        )
                      )
                    ]
                  }
                end
              ),
              "changed_helm_components": (
                if ($changed_files | any(test("^\\.github/workflows/"))) then
                  $all_helm_components | join(" ")
                else
                  [
                    $changed_files[] |
                    select(test("/helm/")) |
                    split("/")[0]
                  ] | unique | join(" ")
                end
              )
            }
          ')

          # Debug output
          echo "Detected changes:"
          echo "================="
          echo "$RESULT" | jq .

          # Extract results
          echo "build-matrix=$(echo "$RESULT" | jq -c '.build_matrix')" >> $GITHUB_OUTPUT
          echo "changed-helm-components=$(echo "$RESULT" | jq -r '.changed_helm_components')" >> $GITHUB_OUTPUT

  build-and-push:
    needs: detect-changes
    if: github.repository == 'rh-ai-quickstart/ai-architecture-charts' && needs.detect-changes.outputs.build-matrix != '{"include":[]}'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.build-matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Extract version from Chart.yaml
        id: version
        run: |
          version=$(grep '^version:' ${{ matrix.chart }} | awk '{print $2}')
          echo "tag=$version" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.file }}
          push: true
          tags: quay.io/ecosystem-appeng/${{ matrix.name }}:${{ steps.version.outputs.tag }}
          build-args: |
            IMAGE_TAG=${{ steps.version.outputs.tag }}

  package-helm-charts:
    needs: detect-changes
    if: github.repository == 'rh-ai-quickstart/ai-architecture-charts' && needs.detect-changes.outputs.changed-helm-components != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Package charts
        run: |
          mkdir -p gh-pages
          read -ra CHANGED_COMPONENTS <<< "${{ needs.detect-changes.outputs.changed-helm-components }}"
          for component in "${CHANGED_COMPONENTS[@]}"; do
            if [ -f "$component/helm/Chart.yaml" ]; then
              echo "Packaging helm chart for $component"
              helm dependency update "$component/helm"

              # Run pre-package script if it exists
              if [ -x "$component/scripts/pre-package.sh" ]; then
                echo "Running pre-package script for $component"
                "$component/scripts/pre-package.sh" "$component/helm"
              fi

              helm package "$component/helm" -d gh-pages
            fi
          done

      - name: Generate Helm index
        run: |
          helm repo index gh-pages --url https://rh-ai-quickstart.github.io/ai-architecture-charts --merge gh-pages/index.yaml

      - name: Commit and push to gh-pages
        run: |
          cd gh-pages
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Update Helm chart repo" || echo "No changes to commit"
          git push origin gh-pages
